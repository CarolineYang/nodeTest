/**
 * tinymce plugin
 * Created by jerry on 16/8/5.
 */
tinymce.PluginManager.add('uploadimage', function (editor) {

    function selectLocalImages() {
        var dom = editor.dom;
        var input_f = $('<input type="file" name="thumbnail" accept="image/jpg,image/jpeg,image/png,image/gif" multiple="multiple">');
        // console.log('>>>>>')
        input_f.on('change', function () {
            // var form = $("<form/>",
            //     {
            //         action: editor.settings.upload_image_url, //设置上传图片的路由，配置在初始化时
            //         style: 'display:none',
            //         method: 'post',
            //         enctype: 'multipart/form-data'
            //     }
            // );
            // form.append(input_f);
            // //ajax提交表单
            // form.ajaxSubmit({
            //     beforeSubmit: function () {
            //         return true;
            //     },
            //     success: function (data) {
            //         if (data && data.file_path) {
            //             editor.focus();
            //             data.file_path.forEach(function (src) {
            //                 editor.selection.setContent(dom.createHTML('img', {src: src}));
            //             })
            //         }
            //     }
            // });
            var formData = new FormData();
            formData.append('file', input_f.get(0).files[0]);
            $.ajax(editor.settings.upload_image_url, {
                type: 'POST',
                processData: false,
                contentType: false,
                data: formData
            }).done(function (result) {
                if (result.code === 1) {
                    // console.log(result);
                    editor.focus();
                    editor.selection.setContent(dom.createHTML('img', {src: result.data}));
                }
            });
        });

        input_f.click();
    }

    editor.addCommand("mceUploadImageEditor", selectLocalImages);

    editor.ui.registry.addButton('uploadimage', {
        icon: 'image',
        tooltip: '上传图片',
        onAction: (_) => editor.execCommand('mceUploadImageEditor')
    });

    editor.ui.registry.addMenuItem('uploadimage', {
        icon: 'image',
        text: '上传图片',
        context: 'tools',
        onAction: (_) => editor.execCommand('mceUploadImageEditor')
    });
});